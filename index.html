<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Ghi hình trận đấu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#f0f4f9; display:flex; flex-direction:row; height:100vh; overflow:hidden; }
    #leftPanel, #rightPanel { padding:8px; box-sizing:border-box; }
    #leftPanel { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; }
    #rightPanel { flex:1; display:flex; flex-direction:column; justify-content:flex-start; align-items:center; gap:8px; }

    #videoContainer { position:relative; max-width:280px; aspect-ratio:16/9; background:#000; border-radius:8px; overflow:hidden; }
    video, canvas { width:100%; height:100%; object-fit:cover; border-radius:8px; }
    #liveIndicator { position:absolute; top:8px; left:8px; width:14px; height:14px; background:red; border-radius:50%; display:none; }

    #scoreboard { margin-top:8px; padding:4px 10px; background:rgba(0,60,120,0.6); color:white; border-radius:8px; text-align:center; font-size:14px; }

    .controls { display:flex; flex-wrap:wrap; justify-content:center; gap:4px; margin-top:8px; }
    .controls button, input { font-size:12px; padding:4px 6px; border:none; border-radius:6px; background:#eee; cursor:pointer; }
    .controls button:disabled { background:#ccc; cursor:not-allowed; }

    .teamControls { display:flex; flex-direction:column; gap:4px; padding:6px; background:#fff; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); width:90%; }
    .teamControls h3 { margin:0; font-size:14px; text-align:center; }
  </style>
</head>
<body>
  <div id="leftPanel">
    <div id="videoContainer">
      <video id="camera" autoplay playsinline muted></video>
      <canvas id="canvas" hidden></canvas>
      <div id="liveIndicator"></div>
    </div>
    <div id="scoreboard">
      <div id="tournamentName">Giải đấu...</div>
      <div><span id="teamAName">Đội A</span> <span id="scoreA">0</span> - <span id="scoreB">0</span> <span id="teamBName">Đội B</span></div>
    </div>
    <div class="controls">
      <input type="text" id="inputTournament" placeholder="Tên giải đấu">
      <input type="text" id="inputTeamA" placeholder="Tên đội A">
      <input type="text" id="inputTeamB" placeholder="Tên đội B">
    </div>
    <div class="controls">
      <button id="startBtn">Bắt đầu</button>
      <button id="stopBtn" disabled>Kết thúc & Lưu</button>
      <select id="qualitySelect">
        <option value="720">720p</option>
        <option value="1080">1080p</option>
      </select>
      <button id="snapshotBtn">Chụp ảnh</button>
    </div>
  </div>

  <div id="rightPanel">
    <div class="teamControls" id="controlsA">
      <h3>Đội A</h3>
      <button id="selectServeA">Chọn giao banh</button>
      <button id="incServeA" disabled>+ Lượt</button>
      <button id="decServeA" disabled>- Lượt</button>
      <button id="incScoreA" disabled>+ Điểm</button>
      <button id="decScoreA" disabled>- Điểm</button>
    </div>
    <div class="teamControls" id="controlsB">
      <h3>Đội B</h3>
      <button id="selectServeB">Chọn giao banh</button>
      <button id="incServeB" disabled>+ Lượt</button>
      <button id="decServeB" disabled>- Lượt</button>
      <button id="incScoreB" disabled>+ Điểm</button>
      <button id="decScoreB" disabled>- Điểm</button>
    </div>
  </div>

  <script>
    const video = document.getElementById("camera");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const liveIndicator = document.getElementById("liveIndicator");

    const scoreAEl = document.getElementById("scoreA");
    const scoreBEl = document.getElementById("scoreB");
    const teamANameEl = document.getElementById("teamAName");
    const teamBNameEl = document.getElementById("teamBName");
    const tournamentNameEl = document.getElementById("tournamentName");

    let scoreA=0, scoreB=0;
    let serveA=0, serveB=0;
    let servingTeam=null;

    let mediaRecorder, recordedChunks=[];
    let stream, drawInterval;

    // Bật camera mặc định khi mở
    async function startCamera() {
      const quality = document.getElementById("qualitySelect").value;
      const constraints = {
        audio: { echoCancellation:true, noiseSuppression:true },
        video: {
          facingMode: { ideal:"environment" },
          width: quality==="1080"?1920:1280,
          height: quality==="1080"?1080:720
        }
      };
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
    }
    startCamera();

    function updateUI() {
      scoreAEl.textContent = scoreA;
      scoreBEl.textContent = scoreB;
      teamANameEl.textContent = document.getElementById("inputTeamA").value || "Đội A";
      teamBNameEl.textContent = document.getElementById("inputTeamB").value || "Đội B";
      tournamentNameEl.textContent = document.getElementById("inputTournament").value || "Giải đấu...";

      // enable buttons
      document.getElementById("incServeA").disabled = servingTeam!=="A";
      document.getElementById("decServeA").disabled = servingTeam!=="A" || serveA<=0;
      document.getElementById("incServeB").disabled = servingTeam!=="B";
      document.getElementById("decServeB").disabled = servingTeam!=="B" || serveB<=0;

      document.getElementById("incScoreA").disabled = serveA<=0;
      document.getElementById("decScoreA").disabled = serveA<=0;
      document.getElementById("incScoreB").disabled = serveB<=0;
      document.getElementById("decScoreB").disabled = serveB<=0;
    }

    // chọn đội giao banh
    document.getElementById("selectServeA").onclick=()=>{ servingTeam="A"; serveA=1; updateUI(); };
    document.getElementById("selectServeB").onclick=()=>{ servingTeam="B"; serveB=1; updateUI(); };

    document.getElementById("incServeA").onclick=()=>{ if(serveA<2) serveA++; updateUI(); };
    document.getElementById("decServeA").onclick=()=>{ 
      if(serveA>0) serveA--; 
      if(serveA===0){ servingTeam="B"; serveB=2; } 
      updateUI(); 
    };
    document.getElementById("incServeB").onclick=()=>{ if(serveB<2) serveB++; updateUI(); };
    document.getElementById("decServeB").onclick=()=>{ 
      if(serveB>0) serveB--; 
      if(serveB===0){ servingTeam="A"; serveA=2; } 
      updateUI(); 
    };

    document.getElementById("incScoreA").onclick=()=>{ scoreA++; updateUI(); };
    document.getElementById("decScoreA").onclick=()=>{ if(scoreA>0) scoreA--; updateUI(); };
    document.getElementById("incScoreB").onclick=()=>{ scoreB++; updateUI(); };
    document.getElementById("decScoreB").onclick=()=>{ if(scoreB>0) scoreB--; updateUI(); };

    // Ghi hình
    document.getElementById("startBtn").onclick=()=>{
      canvas.width=video.videoWidth;
      canvas.height=video.videoHeight;
      const mixedStream = new MediaStream([...stream.getVideoTracks(), ...stream.getAudioTracks()]);
      mediaRecorder = new MediaRecorder(mixedStream, { mimeType:"video/webm;codecs=vp9,opus" });
      mediaRecorder.ondataavailable=e=>{ if(e.data.size>0) recordedChunks.push(e.data); };
      mediaRecorder.start();
      liveIndicator.style.display="block";

      drawInterval = setInterval(()=>{
        ctx.drawImage(video,0,0,canvas.width,canvas.height);
        // vẽ tên, điểm, serve indicator
        ctx.fillStyle="rgba(0,60,120,0.6)";
        ctx.fillRect(canvas.width/2-80,10,160,30);
        ctx.fillStyle="white";
        ctx.font="16px Arial";
        ctx.textAlign="center";
        ctx.fillText(`${teamANameEl.textContent} ${scoreA} - ${scoreB} ${teamBNameEl.textContent}`,canvas.width/2,30);

        // serve indicator
        ctx.fillStyle="red";
        if(servingTeam==="A"){ for(let i=0;i<serveA;i++){ ctx.beginPath(); ctx.arc(30+i*12,canvas.height-20,5,0,2*Math.PI); ctx.fill(); } }
        if(servingTeam==="B"){ for(let i=0;i<serveB;i++){ ctx.beginPath(); ctx.arc(canvas.width-30-i*12,canvas.height-20,5,0,2*Math.PI); ctx.fill(); } }
      },100);
      document.getElementById("startBtn").disabled=true;
      document.getElementById("stopBtn").disabled=false;
    };

    document.getElementById("stopBtn").onclick=()=>{
      mediaRecorder.stop();
      clearInterval(drawInterval);
      liveIndicator.style.display="none";
      video.srcObject.getTracks().forEach(track=>track.stop()); // tắt camera
      mediaRecorder.onstop=()=>{
        const blob = new Blob(recordedChunks,{type:"video/webm"});
        const url=URL.createObjectURL(blob);
        const a=document.createElement("a");
        a.href=url;
        a.download="match_recording.webm";
        a.click();
        recordedChunks=[];
      };
      document.getElementById("startBtn").disabled=false;
      document.getElementById("stopBtn").disabled=true;
    };

    document.getElementById("snapshotBtn").onclick=()=>{
      const snap=document.createElement("a");
      snap.href=canvas.toDataURL("image/png");
      snap.download="snapshot.png";
      snap.click();
    };

    setInterval(updateUI,500);
  </script>
</body>
</html>
