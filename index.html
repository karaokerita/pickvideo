<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Pickleball Recorder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #111;
      color: #fff;
      text-align: center;
    }
    #videoCanvas {
      width: 100%;
      max-width: 600px;
      aspect-ratio: 16/9;
      background: black;
      display: block;
      margin: 10px auto;
      border-radius: 12px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      margin: 10px;
    }
    .controls button {
      flex: 1 1 45%;
      font-size: 1.1em;
      padding: 12px;
      border-radius: 12px;
      border: none;
      background: #333;
      color: #fff;
    }
    .controls button:active {
      background: #555;
    }
    input {
      font-size: 1em;
      padding: 6px;
      border-radius: 8px;
      border: none;
      text-align: center;
    }
  </style>
</head>
<body>
  <canvas id="videoCanvas"></canvas>

  <div class="controls">
    <input id="teamA" placeholder="Đội A" value="A">
    <input id="teamB" placeholder="Đội B" value="B">
  </div>

  <div class="controls">
    <button onclick="score('A',1)">A +</button>
    <button onclick="score('A',-1)">A -</button>
    <button onclick="score('B',1)">B +</button>
    <button onclick="score('B',-1)">B -</button>
  </div>

  <div class="controls">
    <button onclick="toggleServe()">Đổi lượt giao</button>
    <button onclick="resetGame()">Reset</button>
  </div>

  <div class="controls">
    <button onclick="startRecording()">Bắt đầu ghi</button>
    <button onclick="stopRecording()">Dừng ghi</button>
  </div>

  <script>
    const canvas = document.getElementById('videoCanvas');
    const ctx = canvas.getContext('2d');
    const video = document.createElement('video');
    video.playsInline = true;

    let stream, recorder, chunks = [];
    let scoreA = 0, scoreB = 0;
    let servingTeam = "A";
    let serveCountA = 2, serveCountB = 2;
    let startTime = null, timerInterval;

    async function initCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          audio: true,
          video: {
            facingMode: { exact: "environment" },
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          }
        });
      } catch (e) {
        // fallback nếu không chọn được camera sau
        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      }
      video.srcObject = stream;
      await video.play();
      draw();
    }

    function draw() {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      function loop() {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // overlay scoreboard
        ctx.fillStyle = "rgba(0,0,0,0.5)";
        ctx.fillRect(10, 10, 220, 100);

        ctx.fillStyle = "#fff";
        ctx.font = "20px Arial";
        ctx.fillText(document.getElementById("teamA").value + ": " + scoreA, 20, 40);
        ctx.fillText(document.getElementById("teamB").value + ": " + scoreB, 20, 70);

        ctx.fillText("Serve: " + servingTeam, 20, 95);

        // countdown serve count
        ctx.fillText(`A serve left: ${serveCountA}`, 150, 40);
        ctx.fillText(`B serve left: ${serveCountB}`, 150, 70);

        // timer
        if (startTime) {
          let elapsed = Date.now() - startTime;
          let minutes = Math.floor(elapsed / 60000);
          let seconds = Math.floor((elapsed % 60000) / 1000);
          let timeStr = `${minutes}:${seconds.toString().padStart(2, "0")}`;
          ctx.fillText("⏱ " + timeStr, 150, 95);
        }

        requestAnimationFrame(loop);
      }
      loop();
    }

    function score(team, delta) {
      if (team === "A") scoreA = Math.max(0, scoreA + delta);
      if (team === "B") scoreB = Math.max(0, scoreB + delta);
    }

    function toggleServe() {
      if (servingTeam === "A") {
        serveCountA--;
        if (serveCountA <= 0) {
          servingTeam = "B";
          serveCountB = 2;
          serveCountA = 2;
        }
      } else {
        serveCountB--;
        if (serveCountB <= 0) {
          servingTeam = "A";
          serveCountA = 2;
          serveCountB = 2;
        }
      }
    }

    function resetGame() {
      scoreA = 0; scoreB = 0;
      servingTeam = "A";
      serveCountA = 2; serveCountB = 2;
      startTime = null;
    }

    function startRecording() {
      chunks = [];
      recorder = new MediaRecorder(canvas.captureStream(), { mimeType: "video/webm; codecs=vp9" });
      recorder.ondataavailable = e => chunks.push(e.data);
      recorder.onstop = saveRecording;
      recorder.start();
      startTime = Date.now();
    }

    function stopRecording() {
      recorder.stop();
      startTime = null;
    }

    function saveRecording() {
      const blob = new Blob(chunks, { type: "video/webm" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "pickleball_recording.webm";
      a.click();
    }

    initCamera();
  </script>
</body>
</html>
