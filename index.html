<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Ghi h√¨nh thi ƒë·∫•u</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { margin:0; padding:0; font-family: Arial, sans-serif; display:flex; flex-direction:row; height:100vh; background:#111; color:white; }
.left-panel { display:flex; flex-direction:column; align-items:center; flex:1; max-width:360px; background:#000; position:relative; }
canvas { width:100%; aspect-ratio:16/9; background:#000; border:2px solid #444; }
.controls-bottom { display:flex; flex-direction:column; align-items:center; gap:6px; padding:6px; font-size:12px; }
.controls-bottom input, .controls-bottom select, .controls-bottom button { font-size:12px; padding:4px; margin:2px; border-radius:6px; border:none; cursor:pointer; background:#333; color:white; }
.controls-bottom button:hover { background:#555; }
.right-panel { display:flex; flex-direction:row; justify-content:flex-start; align-items:flex-start; flex:1; gap:10px; }
.team { display:flex; flex-direction:column; align-items:center; background:#222; padding:6px; border-radius:10px; min-width:90px; }
.team h3 { margin:2px 0; font-size:14px; }
.team button { margin:2px; padding:4px 6px; border-radius:6px; border:none; background:#333; color:white; cursor:pointer; }
.team button:hover { background:#555; }
#liveIndicator { position:absolute; top:8px; left:8px; background:red; color:white; font-size:12px; padding:2px 5px; border-radius:4px; display:none; }
</style>
</head>
<body>

<div class="left-panel">
  <div id="liveIndicator">‚óè LIVE</div>
  <video id="camera" autoplay playsinline muted style="display:none"></video>
  <canvas id="scoreboard"></canvas>

  <div class="controls-bottom">
    <input type="text" id="tournamentName" placeholder="T√™n gi·∫£i ƒë·∫•u">
    <input type="text" id="teamAName" placeholder="T√™n ƒë·ªôi A">
    <input type="text" id="teamBName" placeholder="T√™n ƒë·ªôi B">
    <select id="resolution">
      <option value="720">720p</option>
      <option value="1080">1080p</option>
    </select>
    <div>
      <button id="recordBtn" onclick="startRecording()">Ghi h√¨nh</button>
      <button onclick="stopRecording()">K·∫øt th√∫c</button>
      <button onclick="captureFrame()">Ch·ª•p ·∫£nh</button>
    </div>
  </div>
</div>

<div class="right-panel">
  <div class="team" id="teamAControls">
    <h3>A</h3>
    <button onclick="chooseServer('A')">Ch·ªçn giao</button>
    <button onclick="changeServe('A',1)">+ Giao</button>
    <button onclick="changeServe('A',-1)">- Giao</button>
    <button onclick="changeScore('A',1)">+ ƒêi·ªÉm</button>
    <button onclick="changeScore('A',-1)">- ƒêi·ªÉm</button>
  </div>

  <div class="team" id="teamBControls">
    <h3>B</h3>
    <button onclick="chooseServer('B')">Ch·ªçn giao</button>
    <button onclick="changeServe('B',1)">+ Giao</button>
    <button onclick="changeServe('B',-1)">- Giao</button>
    <button onclick="changeScore('B',1)">+ ƒêi·ªÉm</button>
    <button onclick="changeScore('B',-1)">- ƒêi·ªÉm</button>
  </div>
</div>

<script>
const video = document.getElementById("camera");
const canvas = document.getElementById("scoreboard");
const ctx = canvas.getContext("2d");
const liveIndicator = document.getElementById("liveIndicator");
const recordBtn = document.getElementById("recordBtn");

let stream, recorder, chunks=[];
let teamA={name:"A", score:0, serve:0};
let teamB={name:"B", score:0, serve:0};
let currentServer=null;

// C·∫≠p nh·∫≠t t√™n ƒë·ªôi hi·ªÉn th·ªã tr√™n canvas
document.getElementById("teamAName").addEventListener("input", e=>{ teamA.name = e.target.value || "A"; });
document.getElementById("teamBName").addEventListener("input", e=>{ teamB.name = e.target.value || "B"; });

window.onload = () => startCamera();

async function startCamera(){
  const resolution = document.getElementById("resolution").value;
  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:"environment", width: resolution=="1080"?1920:1280, height: resolution=="1080"?1080:720 },
      audio:true
    });
    video.srcObject = stream;
    await video.play();
    drawScoreboard();
  } catch(e){ alert("Kh√¥ng m·ªü ƒë∆∞·ª£c camera: "+e);}
}

function drawScoreboard(){
  requestAnimationFrame(drawScoreboard);
  if(!video.videoWidth) return;
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video,0,0,canvas.width,canvas.height);

  // Overlay t√™n gi·∫£i
  ctx.fillStyle="rgba(0,0,100,0.6)";
  ctx.fillRect(0,0,canvas.width,50);
  ctx.fillStyle="white";
  ctx.font="20px Arial";
  ctx.textAlign="center";
  ctx.fillText(document.getElementById("tournamentName").value, canvas.width/2,30);

  // B·∫£ng ƒëi·ªÉm
  ctx.fillStyle="rgba(0,0,100,0.6)";
  ctx.fillRect(0,canvas.height-60,canvas.width,60);
  ctx.fillStyle="white";
  ctx.font="24px Arial";

  const midX = canvas.width/2;

  ctx.textAlign="center";
  ctx.fillText("üèÜ", midX, canvas.height-25);
  ctx.fillText(`${teamA.score} - ${teamB.score}`, midX, canvas.height-50);

  // T√™n ƒë·ªôi s√°t b·∫£ng t·ªâ s·ªë
  ctx.textAlign="left";
  ctx.fillText(teamA.name, midX - 120, canvas.height-25);
  ctx.textAlign="right";
  ctx.fillText(teamB.name, midX + 120, canvas.height-25);

  // Ch·∫•m ƒë·ªè l∆∞·ª£t giao (nh∆∞ phi√™n b·∫£n 1)
  if(teamA.serve>0){
    for(let i=0;i<teamA.serve;i++){
      ctx.beginPath();
      ctx.arc(60+i*15,canvas.height-40,6,0,2*Math.PI);
      ctx.fillStyle="red"; ctx.fill();
    }
  }
  if(teamB.serve>0){
    for(let i=0;i<teamB.serve;i++){
      ctx.beginPath();
      ctx.arc(canvas.width-60-i*15,canvas.height-40,6,0,2*Math.PI);
      ctx.fillStyle="red"; ctx.fill();
    }
  }
}

function chooseServer(team){
  currentServer = team;
  if(team=="A"){ teamA.serve=1; teamB.serve=0; }
  else { teamB.serve=1; teamA.serve=0; }
}

function changeServe(team, delta){
  if(team=="A" && currentServer=="A"){
    teamA.serve=Math.min(Math.max(teamA.serve+delta,0),2);
    if(teamA.serve==0){ teamB.serve=2; currentServer="B"; }
  }
  if(team=="B" && currentServer=="B"){
    teamB.serve=Math.min(Math.max(teamB.serve+delta,0),2);
    if(teamB.serve==0){ teamA.serve=2; currentServer="A"; }
  }
}

function changeScore(team, delta){
  if(team=="A" && teamA.serve>0) teamA.score=Math.max(teamA.score+delta,0);
  if(team=="B" && teamB.serve>0) teamB.score=Math.max(teamB.score+delta,0);
}

function startRecording(){
  if(!stream){ alert("Camera ch∆∞a s·∫µn s√†ng"); return; }
  chunks=[];
  recorder = new MediaRecorder(stream);
  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.start();
  liveIndicator.style.display="block";
  recordBtn.style.background="red";
  recordBtn.disabled=true;
}

function stopRecording(){
  if(recorder && recorder.state!="inactive"){
    recorder.onstop = () => {
      saveRecording();
      if(stream) stream.getTracks().forEach(t=>t.stop());
      liveIndicator.style.display="none";
      recordBtn.style.background="#333";
      recordBtn.disabled=false;
    };
    recorder.stop();
  } else if(stream){
    stream.getTracks().forEach(t=>t.stop());
    liveIndicator.style.display="none";
    recordBtn.style.background="#333";
    recordBtn.disabled=false;
  }
}

function saveRecording(){
  if(chunks.length==0) return;
  const blob = new Blob(chunks,{type:"video/webm"});
  const url = URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="match.webm";
  a.click();
}

function captureFrame(){
  const a=document.createElement("a");
  a.href=canvas.toDataURL("image/png");
  a.download="frame.png";
  a.click();
}
</script>
</body>
</html>
