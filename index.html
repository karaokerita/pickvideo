<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Ghi h√¨nh Pickleball</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { margin:0; padding:0; font-family:Arial,sans-serif; background:#111; color:white; display:flex; flex-direction:row; height:100vh; }
.left-panel { flex:1; max-width:320px; display:flex; flex-direction:column; align-items:center; background:#000; position:relative; }
video, canvas { width:100%; aspect-ratio:16/9; background:#000; border:2px solid #444; }
.controls-bottom { display:flex; flex-direction:column; gap:6px; padding:6px; font-size:12px; width:100%; }
.controls-bottom select, .controls-bottom button, .controls-bottom input { font-size:12px; padding:4px; margin:2px; border-radius:6px; border:none; background:#333; color:white; cursor:pointer; }
.controls-bottom button:hover { background:#555; }
.right-panel { flex:1; display:flex; flex-direction:row; justify-content:space-around; align-items:flex-start; padding:4px; gap:10px; }
.team { display:flex; flex-direction:column; align-items:center; background:#222; padding:6px; border-radius:10px; min-width:140px; }
.team h3 { margin:2px 0; font-size:14px; }
.team input, .team button { margin:2px; padding:4px 6px; border-radius:6px; border:none; background:#333; color:white; cursor:pointer; font-size:12px; }
.team input { width:100px; }
.team button:hover { background:#555; }
#liveIndicator { position:absolute; top:8px; left:8px; background:red; color:white; font-size:12px; padding:2px 5px; border-radius:4px; display:none; }
#progressContainer { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); display:none; background:rgba(0,0,0,0.7); padding:10px 20px; border-radius:10px; font-size:16px; color:white; }
</style>
</head>
<body>

<div class="left-panel">
  <div id="liveIndicator">‚óè LIVE</div>
  <video id="camera" autoplay playsinline muted></video>
  <canvas id="scoreboard"></canvas>
  
  <div class="controls-bottom">
    <input type="text" id="tournamentName" placeholder="T√™n gi·∫£i ƒë·∫•u">
    <select id="resolution">
      <option value="720">720p</option>
      <option value="1080">1080p</option>
    </select>
    <div>
      <button id="recordBtn" onclick="startRecording()">Ghi h√¨nh</button>
      <button onclick="stopRecording()">K·∫øt th√∫c</button>
      <button onclick="captureFrame()">Ch·ª•p ·∫£nh</button>
    </div>
  </div>
</div>

<div class="right-panel">
  <div class="team" id="teamAControls">
    <h3 id="teamAHeader">ƒê·ªôi A</h3>
    <input type="text" id="teamAName" placeholder="T√™n ƒë·ªôi A">
    <button onclick="chooseServer('A')">Ch·ªçn giao</button>
    <button onclick="changeServe('A',1)">+ Giao</button>
    <button onclick="changeServe('A',-1)">- Giao</button>
    <button onclick="changeScore('A',1)">+ ƒêi·ªÉm</button>
    <button onclick="changeScore('A',-1)">- ƒêi·ªÉm</button>
  </div>

  <div class="team" id="teamBControls">
    <h3 id="teamBHeader">ƒê·ªôi B</h3>
    <input type="text" id="teamBName" placeholder="T√™n ƒë·ªôi B">
    <button onclick="chooseServer('B')">Ch·ªçn giao</button>
    <button onclick="changeServe('B',1)">+ Giao</button>
    <button onclick="changeServe('B',-1)">- Giao</button>
    <button onclick="changeScore('B',1)">+ ƒêi·ªÉm</button>
    <button onclick="changeScore('B',-1)">- ƒêi·ªÉm</button>
  </div>
</div>

<div id="progressContainer">Convert video: 0%</div>

<script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.8/dist/ffmpeg.min.js"></script>
<script>
const { createFFmpeg, fetchFile } = FFmpeg;
const ffmpeg = createFFmpeg({ log:true, progress: p => {
  if(p && p.ratio!==undefined){
    document.getElementById('progressContainer').style.display='block';
    document.getElementById('progressContainer').innerText = `Convert video: ${Math.floor(p.ratio*100)}%`;
  }
}});

const video = document.getElementById("camera");
const canvas = document.getElementById("scoreboard");
const ctx = canvas.getContext("2d");
const liveIndicator = document.getElementById("liveIndicator");
const recordBtn = document.getElementById("recordBtn");
const progressContainer = document.getElementById("progressContainer");

let stream, recorder, chunks=[];
let teamA={name:"A", score:0, serve:0};
let teamB={name:"B", score:0, serve:0};
let currentServer=null;
let startTime = null;

document.getElementById("teamAName").addEventListener("input", e=>{
  teamA.name = e.target.value || "A";
  document.getElementById("teamAHeader").innerText = teamA.name;
});
document.getElementById("teamBName").addEventListener("input", e=>{
  teamB.name = e.target.value || "B";
  document.getElementById("teamBHeader").innerText = teamB.name;
});

function drawScoreboard(){
  requestAnimationFrame(drawScoreboard);
  if(!video.videoWidth) return;
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video,0,0,canvas.width,canvas.height);

  // Tournament name
  ctx.fillStyle="rgba(0,0,100,0.6)";
  ctx.fillRect(0,0,canvas.width,50);
  ctx.fillStyle="white";
  ctx.font="20px Arial";
  ctx.textAlign="center";
  ctx.fillText(document.getElementById("tournamentName").value, canvas.width/2,30);

  // Bottom scoreboard
  ctx.fillStyle="rgba(0,0,100,0.6)";
  ctx.fillRect(0,canvas.height-60,canvas.width,60);
  ctx.fillStyle="white";
  ctx.font="24px Arial";
  const midX = canvas.width/2;
  ctx.textAlign="center";
  ctx.fillText("üèÜ", midX, canvas.height-25);
  ctx.fillText(`${teamA.score} - ${teamB.score}`, midX, canvas.height-50);
  ctx.textAlign="left"; ctx.fillText(teamA.name, midX-120, canvas.height-25);
  ctx.textAlign="right"; ctx.fillText(teamB.name, midX+120, canvas.height-25);

  // Serve indicators
  if(teamA.serve>0) for(let i=0;i<teamA.serve;i++){ ctx.beginPath(); ctx.arc(60+i*15,canvas.height-40,6,0,2*Math.PI); ctx.fillStyle="red"; ctx.fill(); }
  if(teamB.serve>0) for(let i=0;i<teamB.serve;i++){ ctx.beginPath(); ctx.arc(canvas.width-60-i*15,canvas.height-40,6,0,2*Math.PI); ctx.fillStyle="red"; ctx.fill(); }

  // Timer
  if(startTime){
    const elapsed = Math.floor((Date.now()-startTime)/1000);
    const minutes = Math.floor(elapsed/60).toString().padStart(2,'0');
    const seconds = (elapsed%60).toString().padStart(2,'0');
    ctx.fillStyle="white";
    ctx.font="18px Arial";
    ctx.textAlign="right";
    ctx.fillText(`${minutes}:${seconds}`, canvas.width-10,30);
  }
}

async function startCamera(){
  if(stream) return;
  const resolution = document.getElementById("resolution").value;
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:{exact:"environment"}, width: resolution=="1080"?1920:1280, height: resolution=="1080"?1080:720 },
      audio:true
    });
    video.srcObject = stream;
    await video.play();
    liveIndicator.style.display="none";
  } catch(e){ alert("Kh√¥ng m·ªü ƒë∆∞·ª£c camera: "+e); }
}

function chooseServer(team){
  if(currentServer) return; // ch·ªâ 1 l·∫ßn ch·ªçn
  currentServer = team;
  if(team=="A"){ teamA.serve=1; teamB.serve=0; }
  else { teamB.serve=1; teamA.serve=0; }
}

function changeServe(team,delta){
  if(team=="A" && currentServer=="A"){ 
    teamA.serve=Math.min(Math.max(teamA.serve+delta,0),2); 
    if(teamA.serve==0){ teamB.serve=2; currentServer="B"; }
  }
  if(team=="B" && currentServer=="B"){ 
    teamB.serve=Math.min(Math.max(teamB.serve+delta,0),2); 
    if(teamB.serve==0){ teamA.serve=2; currentServer="A"; }
  }
}

function changeScore(team,delta){
  if(team=="A" && teamA.serve>0) teamA.score=Math.max(teamA.score+delta,0);
  if(team=="B" && teamB.serve>0) teamB.score=Math.max(teamB.score+delta,0);
}

function startRecording(){
  if(!stream){ alert("Camera ch∆∞a s·∫µn s√†ng"); return; }
  chunks=[];
  recorder = new MediaRecorder(stream);
  recorder.ondataavailable = e=>chunks.push(e.data);
  recorder.start();
  startTime = Date.now();
  liveIndicator.style.display="block";
  recordBtn.style.background="red";
  recordBtn.disabled=true;
}

function stopRecording(){
  if(!recorder) return;
  recorder.onstop = async ()=>{
    liveIndicator.style.display="none";
    recordBtn.style.background="#333";
    recordBtn.disabled=false;
    startTime = null;
    await convertWebMtoMP4(new Blob(chunks,{type:'video/webm'}));
    stream.getTracks().forEach(t=>t.stop());
    stream=null;
  };
  recorder.stop();
}

async function convertWebMtoMP4(webmBlob){
  progressContainer.style.display='block';
  if(!ffmpeg.isLoaded()) await ffmpeg.load();
  ffmpeg.FS('writeFile','input.webm', await fetchFile(webmBlob));
  await ffmpeg.run('-i','input.webm','-c:v','libx264','-c:a','aac','output.mp4');
  const data = ffmpeg.FS('readFile','output.mp4');
  const mp4Blob = new Blob([data.buffer],{type:'video/mp4'});
  const url = URL.createObjectURL(mp4Blob);
  const a = document.createElement('a'); a.href=url; a.download='match.mp4'; a.click();
  progressContainer.style.display='none';
  alert("Video MP4 ƒë√£ s·∫µn s√†ng, b·∫°n c√≥ th·ªÉ l∆∞u v√†o Photos tr√™n iPhone.");
}

function captureFrame(){
  const a=document.createElement('a');
  a.href=canvas.toDataURL('image/png');
  a.download='frame.png';
  a.click();
}

window.onload = () => {
  startCamera();
  drawScoreboard();
};
</script>
</body>
</html>
