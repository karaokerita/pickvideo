<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Quay video giải đấu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    body {
      margin: 0; padding: 0;
      font-family: sans-serif;
      display: flex; flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #111; color: #fff;
    }

    .container {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 100%;
    }

    @media (orientation: landscape) {
      .container {
        flex-direction: row;
        align-items: flex-start;
        justify-content: center;
      }
    }

    /* Camera khung nhỏ gọn */
    .camera-wrapper {
      max-width: 320px;
      aspect-ratio: 16/9;
      background: black;
      position: relative;
    }

    video, canvas {
      width: 100%; height: 100%;
      position: absolute; top: 0; left: 0;
      object-fit: cover;
    }

    /* Live indicator (DOM, không ghi video) */
    .live-indicator {
      position: absolute;
      top: 8px; left: 8px;
      background: red;
      color: white;
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 12px;
      display: none;
    }

    /* Khu vực nút */
    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 8px;
      padding: 10px;
      flex: 1;
    }

    @media (orientation: landscape) {
      .controls {
        display: flex;
        flex-direction: column;
        flex-wrap: nowrap;
        align-items: stretch;
        justify-content: flex-start;
        max-height: 100vh;
        overflow-y: auto;
      }
    }

    button, input {
      font-size: clamp(14px, 2vw, 18px);
      padding: clamp(6px, 2vw, 12px);
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    button {
      background: #333; color: #fff;
    }

    button:active {
      background: #555;
    }

    .scoreboard {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: clamp(14px, 2vw, 18px);
    }

    .team {
      flex: 1;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Camera -->
    <div class="camera-wrapper">
      <video id="camera" autoplay playsinline muted></video>
      <canvas id="overlay"></canvas>
      <div class="live-indicator" id="liveIndicator">● LIVE</div>
    </div>

    <!-- Nút chức năng -->
    <div class="controls">
      <input type="text" id="tournamentName" placeholder="Tên giải đấu">
      <input type="text" id="team1Name" placeholder="Đội 1" value="Team A">
      <input type="text" id="team2Name" placeholder="Đội 2" value="Team B">

      <button id="startRecord">Ghi hình</button>
      <button id="stopRecord" disabled>Dừng</button>
      <button id="capture">Chụp ảnh</button>
      <button id="download" disabled>Lưu video</button>

      <div class="scoreboard">
        <div class="team"><span id="team1Score">0</span></div>
        <div class="team"><span id="team2Score">0</span></div>
      </div>
      <button id="team1Plus">+ Điểm Đ1</button>
      <button id="team1Minus">- Điểm Đ1</button>
      <button id="team2Plus">+ Điểm Đ2</button>
      <button id="team2Minus">- Điểm Đ2</button>

      <button id="serveTeam1">Đội 1 giao</button>
      <button id="serveTeam2">Đội 2 giao</button>
      <button id="serveMinus">- Lượt giao</button>
      <button id="servePlus">+ Lượt giao</button>

      <select id="resolution">
        <option value="720">720p</option>
        <option value="1080">1080p</option>
      </select>
    </div>
  </div>

  <script>
    const video = document.getElementById('camera');
    const canvas = document.getElementById('overlay');
    const ctx = canvas.getContext('2d');
    const liveIndicator = document.getElementById('liveIndicator');
    const team1ScoreEl = document.getElementById('team1Score');
    const team2ScoreEl = document.getElementById('team2Score');

    let team1Score = 0, team2Score = 0;
    let serveTeam = 1;
    let serveCount = 1;
    let recording = false, recorder, recordedChunks = [];
    let timerInterval, startTime;

    async function initCamera(res = 720) {
      const constraints = {
        audio: true,
        video: {
          facingMode: "environment",
          width: res === 1080 ? 1920 : 1280,
          height: res === 1080 ? 1080 : 720
        }
      };
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
    }

    function drawOverlay() {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Đồng hồ
      if (recording) {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const m = String(Math.floor(elapsed / 60)).padStart(2, '0');
        const s = String(elapsed % 60).padStart(2, '0');
        ctx.fillStyle = "white";
        ctx.font = "30px sans-serif";
        ctx.fillText(`${m}:${s}`, canvas.width - 100, 40);
      }

      // Serve indicator
      ctx.fillStyle = "red";
      if (serveTeam === 1) {
        for (let i = 0; i < serveCount; i++)
          ctx.beginPath(), ctx.arc(30 + i*20, 30, 8, 0, 2 * Math.PI), ctx.fill();
      } else {
        for (let i = 0; i < serveCount; i++)
          ctx.beginPath(), ctx.arc(canvas.width - 30 - i*20, 30, 8, 0, 2 * Math.PI), ctx.fill();
      }

      requestAnimationFrame(drawOverlay);
    }

    document.getElementById('startRecord').onclick = () => {
      liveIndicator.style.display = "block";
      startTime = Date.now();
      recording = true;
      recordedChunks = [];
      const stream = canvas.captureStream(30);
      const audioTracks = video.srcObject.getAudioTracks();
      if (audioTracks.length) stream.addTrack(audioTracks[0]);
      recorder = new MediaRecorder(stream);
      recorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
      recorder.onstop = () => {
        const blob = new Blob(recordedChunks, {type: "video/webm"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = "match.webm"; a.click();
      };
      recorder.start();
      document.getElementById('stopRecord').disabled = false;
    };

    document.getElementById('stopRecord').onclick = () => {
      recording = false;
      liveIndicator.style.display = "none";
      recorder.stop();
      document.getElementById('stopRecord').disabled = true;
    };

    document.getElementById('capture').onclick = () => {
      const img = canvas.toDataURL("image/png");
      const a = document.createElement("a");
      a.href = img; a.download = "snapshot.png"; a.click();
    };

    // Điểm số
    document.getElementById('team1Plus').onclick = () => team1ScoreEl.textContent = ++team1Score;
    document.getElementById('team1Minus').onclick = () => team1ScoreEl.textContent = Math.max(0, --team1Score);
    document.getElementById('team2Plus').onclick = () => team2ScoreEl.textContent = ++team2Score;
    document.getElementById('team2Minus').onclick = () => team2ScoreEl.textContent = Math.max(0, --team2Score);

    // Giao bóng
    document.getElementById('serveTeam1').onclick = () => { serveTeam = 1; serveCount = 1; };
    document.getElementById('serveTeam2').onclick = () => { serveTeam = 2; serveCount = 1; };
    document.getElementById('serveMinus').onclick = () => {
      if (serveCount > 0) serveCount--;
      if (serveCount === 0) {
        serveTeam = serveTeam === 1 ? 2 : 1;
        serveCount = 2;
      }
    };
    document.getElementById('servePlus').onclick = () => { if (serveCount < 2) serveCount++; };

    document.getElementById('resolution').onchange = e => initCamera(Number(e.target.value));

    initCamera();
    drawOverlay();
  </script>
</body>
</html>
